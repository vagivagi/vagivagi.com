---
title: Concourse CIでPivotal Web Serviceに自動デプロイする
tags: ["Pivotal Application Service","Cloud Foundry","Concourse CI"]
categories: ["Dev", "CI", "ConcourseCI"]
---

Blog APIのデプロイを手動からConcourse CI(Ver.5.0)で自動デプロイできるようにしたので、メモ。  
できるようにしたのは下記の通り。  

1. GitHubのmasterブランチにコードがpushされたら、テストを実行する
2. テスト成功後、Pivotal Web Service(Cloud Foundry)にデプロイする
<br>

## 単体テストの実行

単体テストを実行するためには、  

1. GitHubのリポジトリからソースコードを取得する
  - こちらはgitリソースをgetするだけなので、説明は割愛。最終的な設定ファイルを確認すれば良い。
2. Mavenコマンドを実行する(コンテナイメージを取得する)

が必要となる。  

注意点としては、ConcourseはCI実行時に毎回一からコンテナを作成するため、依存ライブラリを毎回ダウンロードすると、時間がかかる。そのため、キャッシュ処理を書いた方が良い。  

### Mavenコマンド実行タスク

``` yml

```

## デプロイ

Cloud Foundry(PaaS)にデプロイする手順を示す。ここでは[Pivotal Application Service](https://run.pivotal.io)を利用する。前提として、アカウントは作成済みであること。  
※Pivotal Application Serviceは最近リブランドされて、VMware Tanzu Application Serviceにリネームされたとのこと.  

## cf-resource

公式のリソースがあるので、それを活用する。  
[cf-resource](https://github.com/cloudfoundry-community/cf-resource)

注意点としては、認証情報を記載する必要があるので、設定ファイルと認証情報ファイルを分けて、認証情報ファイルをコミットしないようにする。ただし、`fly get pipeline`コマンドでパイプラインファイルを取得できてしまう。VaultやCredHubのような機密情報管理サービスを使う方法もあるが、今回は個人利用のため、採用していない。

## 最終的な設定ファイル


pipeline.yml
<br>

``` yml

```

credentials.yml
<br>
``` yml

```

setup-pipeline.sh
<br>
``` sh

```

manifest.yml
<br>
``` yml

```

### 参考リンク
